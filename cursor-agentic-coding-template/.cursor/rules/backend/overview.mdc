---
description: Outlines architectural principles and best practices for backend development, including API design, data persistence, and service-to-service communication.
---

# ğŸ—ï¸ å¾Œç«¯æ¶æ§‹

## åˆ†å±¤æ¶æ§‹
```
Controller â†’ Service â†’ Repository â†’ Database
    â†“           â†“           â†“
   DTO      Business    Entity/Model
            Logic
```

## è·è²¬åˆ†é›¢
- **Controller**: è™•ç† HTTP è«‹æ±‚/å›æ‡‰
- **Service**: æ¥­å‹™é‚è¼¯è™•ç†
- **Repository**: è³‡æ–™å­˜å–å±¤
- **Model**: è³‡æ–™æ¨¡å‹å®šç¾©

# ğŸ” API è¨­è¨ˆ

## RESTful åŸå‰‡
```typescript
// âœ… Good
GET    /api/users       // åˆ—è¡¨
GET    /api/users/:id   // è©³æƒ…
POST   /api/users       // å‰µå»º
PUT    /api/users/:id   // å®Œæ•´æ›´æ–°
PATCH  /api/users/:id   // éƒ¨åˆ†æ›´æ–°
DELETE /api/users/:id   // åˆªé™¤

// âŒ Bad
GET /api/getUserList
POST /api/deleteUser
```

## å›æ‡‰æ ¼å¼
```typescript
// æˆåŠŸå›æ‡‰
{
  "success": true,
  "data": { /* actual data */ },
  "meta": {
    "timestamp": "2024-01-01T00:00:00Z",
    "version": "1.0.0"
  }
}

// éŒ¯èª¤å›æ‡‰
{
  "success": false,
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "User not found",
    "details": { /* additional info */ }
  }
}
```

## ç‹€æ…‹ç¢¼ä½¿ç”¨
- **200 OK**: æˆåŠŸå–å¾—è³‡æº
- **201 Created**: æˆåŠŸå‰µå»ºè³‡æº
- **204 No Content**: æˆåŠŸä½†ç„¡å…§å®¹
- **400 Bad Request**: è«‹æ±‚åƒæ•¸éŒ¯èª¤
- **401 Unauthorized**: æœªèªè­‰
- **403 Forbidden**: ç„¡æ¬Šé™
- **404 Not Found**: è³‡æºä¸å­˜åœ¨
- **422 Unprocessable Entity**: é©—è­‰å¤±æ•—
- **500 Internal Server Error**: ä¼ºæœå™¨éŒ¯èª¤

# ğŸ›¡ï¸ å®‰å…¨æªæ–½

## èªè­‰æˆæ¬Š
- **JWT Token**: ç„¡ç‹€æ…‹èªè­‰
- **Refresh Token**: é•·æœŸæœ‰æ•ˆæ€§
- **æ¬Šé™æª¢æŸ¥**: RBAC/ABAC
- **Session ç®¡ç†**: Redis å„²å­˜

## è³‡æ–™é©—è­‰
```typescript
// ä½¿ç”¨ Zod é©—è­‰
const createUserSchema = z.object({
  email: z.string().email(),
  password: z.string().min(8),
  name: z.string().min(2).max(50),
  age: z.number().min(0).max(150)
})

// ä¸­é–“ä»¶é©—è­‰
const validate = (schema) => (req, res, next) => {
  try {
    schema.parse(req.body)
    next()
  } catch (error) {
    res.status(422).json({ error })
  }
}
```

## SQL æ³¨å…¥é˜²è­·
```typescript
// âœ… Good: åƒæ•¸åŒ–æŸ¥è©¢
const user = await db.query(
  'SELECT * FROM users WHERE id = $1',
  [userId]
)

// âŒ Bad: å­—ä¸²ä¸²æ¥
const user = await db.query(
  `SELECT * FROM users WHERE id = ${userId}`
)
```

# ğŸ’¾ è³‡æ–™åº«è¨­è¨ˆ

## Schema è¨­è¨ˆåŸå‰‡
- **æ­£è¦åŒ–**: è‡³å°‘åˆ° 3NF
- **ç´¢å¼•ç­–ç•¥**: æŸ¥è©¢æ¬„ä½å»ºç«‹ç´¢å¼•
- **è»Ÿåˆªé™¤**: deleted_at æ¬„ä½
- **å¯©è¨ˆæ¬„ä½**: created_at, updated_at, created_by

## ORM/Query Builder
```typescript
// Prisma example
const user = await prisma.user.create({
  data: {
    email: 'user@example.com',
    posts: {
      create: [
        { title: 'Hello World' }
      ]
    }
  },
  include: {
    posts: true
  }
})
```

## äº¤æ˜“è™•ç†
```typescript
// ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§
await db.transaction(async (trx) => {
  await trx.user.update({ ... })
  await trx.wallet.update({ ... })
  await trx.log.create({ ... })
})
```

# âš¡ æ•ˆèƒ½å„ªåŒ–

## å¿«å–ç­–ç•¥
- **Redis**: Sessionã€ç†±é»æ•¸æ“š
- **Memory Cache**: å¸¸ç”¨è¨­å®š
- **CDN**: éœæ…‹è³‡æº
- **Database Cache**: æŸ¥è©¢çµæœ

## æŸ¥è©¢å„ªåŒ–
- **é¿å… N+1 å•é¡Œ**: ä½¿ç”¨ include/join
- **åˆ†é è™•ç†**: cursor-based pagination
- **æ‰¹é‡æ“ä½œ**: bulk insert/update
- **éåŒæ­¥è™•ç†**: ä½¿ç”¨ queue

## ä¸¦ç™¼è™•ç†
```typescript
// Node.js cluster
import cluster from 'cluster'
import { cpus } from 'os'

if (cluster.isMaster) {
  const numWorkers = cpus().length
  for (let i = 0; i < numWorkers; i++) {
    cluster.fork()
  }
} else {
  startServer()
}
```

# ğŸ“ æ—¥èªŒç›£æ§

## æ—¥èªŒå±¤ç´š
- **ERROR**: éŒ¯èª¤ï¼Œéœ€è¦ç«‹å³è™•ç†
- **WARN**: è­¦å‘Šï¼Œå¯èƒ½çš„å•é¡Œ
- **INFO**: ä¸€èˆ¬è³‡è¨Šï¼Œé‡è¦äº‹ä»¶
- **DEBUG**: é™¤éŒ¯è³‡è¨Šï¼Œé–‹ç™¼ç’°å¢ƒ

## çµæ§‹åŒ–æ—¥èªŒ
```typescript
logger.info('User login', {
  userId: user.id,
  email: user.email,
  ip: req.ip,
  userAgent: req.headers['user-agent'],
  timestamp: new Date().toISOString()
})
```

## ç›£æ§æŒ‡æ¨™
- **API å›æ‡‰æ™‚é–“**
- **éŒ¯èª¤ç‡**
- **è«‹æ±‚é‡ QPS**
- **è³‡æ–™åº«é€£ç·šæ± **
- **è¨˜æ†¶é«”ä½¿ç”¨ç‡**

# ğŸš€ éƒ¨ç½²é…ç½®

## ç’°å¢ƒè®Šæ•¸
```bash
# .env.example
NODE_ENV=production
PORT=3000
DATABASE_URL=postgresql://...
REDIS_URL=redis://...
JWT_SECRET=your-secret-key
API_KEY=your-api-key
```

## å¥åº·æª¢æŸ¥
```typescript
app.get('/health', (req, res) => {
  res.json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    memory: process.memoryUsage(),
  })
})
```

## Graceful Shutdown
```typescript
process.on('SIGTERM', async () => {
  logger.info('SIGTERM received, closing connections...')
  await server.close()
  await db.disconnect()
  await redis.disconnect()
  process.exit(0)
})
```

# ğŸš« å¾Œç«¯ç¦å¿Œ

## çµ•å°ä¸å¯ä»¥
- âŒ æ˜æ–‡å„²å­˜å¯†ç¢¼
- âŒ åœ¨æ—¥èªŒä¸­è¨˜éŒ„æ•æ„Ÿè³‡è¨Š
- âŒ å¿½ç•¥éŒ¯èª¤è™•ç†
- âŒ ç„¡é™åˆ¶çš„è³‡æºä½¿ç”¨
- âŒ åŒæ­¥çš„é˜»å¡æ“ä½œ

## å¸¸è¦‹éŒ¯èª¤
- ğŸš« å¾ªç’°å‘¼å«è³‡æ–™åº«
- ğŸš« æœªè™•ç† Promise rejection
- ğŸš« è¨˜æ†¶é«”æ´©æ¼ï¼ˆæœªæ¸…ç† listenersï¼‰
- ğŸš« ç¡¬ç·¨ç¢¼é…ç½®å€¼
- ğŸš« å¿½ç•¥ CORS è¨­ç½®