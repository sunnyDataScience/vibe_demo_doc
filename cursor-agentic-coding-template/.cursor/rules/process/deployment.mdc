---
description: Provides a checklist and standard operating procedures for deploying the application to production.
applyIntelligently: true
globs:
  - "deploy/**/*"
  - ".github/workflows/*"
  - "Dockerfile"
  - "docker-compose*.yml"
  - "k8s/**/*"
  - ".env*"
---

# ğŸš€ éƒ¨ç½²ç­–ç•¥

## ç’°å¢ƒåˆ†å±¤
```yaml
Development:
  - æœ¬åœ°é–‹ç™¼ç’°å¢ƒ
  - ç†±é‡è¼‰å•Ÿç”¨
  - Debug æ¨¡å¼é–‹å•Ÿ
  - Mock è³‡æ–™å¯ç”¨

Staging:
  - é¡ç”Ÿç”¢ç’°å¢ƒ
  - çœŸå¯¦è³‡æ–™åº«ï¼ˆæ¸¬è©¦è³‡æ–™ï¼‰
  - å®Œæ•´ç›£æ§
  - è‡ªå‹•éƒ¨ç½²

Production:
  - ç”Ÿç”¢ç’°å¢ƒ
  - é«˜å¯ç”¨æ¶æ§‹
  - å®Œæ•´å‚™æ´
  - æ‰‹å‹•æ‰¹å‡†éƒ¨ç½²
```

# ğŸ³ å®¹å™¨åŒ–é…ç½®

## Dockerfile æœ€ä½³å¯¦è¸
```dockerfile
# Multi-stage build
FROM node:20-alpine AS builder
WORKDIR /app
# åªè¤‡è£½ package files å„ªåŒ–å¿«å–
COPY package*.json ./
RUN npm ci --only=production

# å»ºæ§‹éšæ®µ
COPY . .
RUN npm run build

# åŸ·è¡Œéšæ®µ - æœ€å°åŒ–æ˜ åƒ
FROM node:20-alpine AS runner
WORKDIR /app

# å®‰å…¨æ€§ï¼šé root ä½¿ç”¨è€…
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

# åªè¤‡è£½å¿…è¦æª”æ¡ˆ
COPY --from=builder --chown=nextjs:nodejs /app/build ./build
COPY --from=builder --chown=nextjs:nodejs /app/node_modules ./node_modules

USER nextjs
EXPOSE 3000

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node healthcheck.js

CMD ["node", "build/index.js"]
```

## Docker Compose é…ç½®
```yaml
version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NODE_ENV=production
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data

volumes:
  postgres-data:
  redis-data:

networks:
  app-network:
    driver: bridge
```

# â˜¸ï¸ Kubernetes éƒ¨ç½²

## Deployment é…ç½®
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-deployment
  labels:
    app: web-app
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: web-app
  template:
    metadata:
      labels:
        app: web-app
    spec:
      containers:
      - name: app
        image: registry.example.com/app:latest
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
```

# ğŸ”„ CI/CD Pipeline

## GitHub Actions
```yaml
name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: |
          npm run test:unit
          npm run test:integration

      - name: Check code quality
        run: |
          npm run lint
          npm run type-check

  build:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Deploy to Kubernetes
        run: |
          kubectl set image deployment/app-deployment \
            app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/app-deployment

      - name: Run smoke tests
        run: |
          curl -f https://api.example.com/health || exit 1
```

# ğŸ¯ éƒ¨ç½²ç­–ç•¥

## Blue-Green Deployment
```bash
#!/bin/bash
# blue-green-deploy.sh

# éƒ¨ç½²åˆ° Green ç’°å¢ƒ
kubectl apply -f k8s/green-deployment.yaml

# ç­‰å¾… Green ç’°å¢ƒå°±ç·’
kubectl wait --for=condition=available --timeout=300s \
  deployment/green-deployment

# åŸ·è¡Œå¥åº·æª¢æŸ¥
./scripts/health-check.sh green || exit 1

# åˆ‡æ›æµé‡åˆ° Green
kubectl patch service app-service \
  -p '{"spec":{"selector":{"version":"green"}}}'

# é©—è­‰åˆ‡æ›æˆåŠŸ
sleep 10
./scripts/verify-deployment.sh

# ä¿ç•™ Blue ç’°å¢ƒ 1 å°æ™‚å¾Œæ¸…ç†
echo "Scheduling Blue environment cleanup in 1 hour"
at now + 1 hour <<< "kubectl delete deployment blue-deployment"
```

## Canary Deployment
```yaml
# 10% æµé‡åˆ°æ–°ç‰ˆæœ¬
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: canary-ingress
  annotations:
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-weight: "10"
spec:
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: app-service-canary
            port:
              number: 80
```

# ğŸ” éƒ¨ç½²å®‰å…¨

## å¯†é‘°ç®¡ç†
```bash
# ä½¿ç”¨ Kubernetes Secrets
kubectl create secret generic app-secrets \
  --from-literal=db-password=$DB_PASSWORD \
  --from-literal=api-key=$API_KEY

# åœ¨ Pod ä¸­ä½¿ç”¨
env:
  - name: DATABASE_PASSWORD
    valueFrom:
      secretKeyRef:
        name: app-secrets
        key: db-password

# ä½¿ç”¨ Sealed Secrets
kubeseal --format=yaml < secret.yaml > sealed-secret.yaml
```

## ç’°å¢ƒè®Šæ•¸ç®¡ç†
```bash
# .env.example (æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶)
NODE_ENV=production
PORT=3000
DATABASE_URL=postgresql://user:pass@host:5432/db
REDIS_URL=redis://localhost:6379

# .env.production (ä¸æäº¤)
NODE_ENV=production
PORT=3000
DATABASE_URL=postgresql://prod_user:${SECRET_PASSWORD}@prod.db:5432/prod_db
API_KEY=${SECRET_API_KEY}
JWT_SECRET=${SECRET_JWT}
```

# ğŸ“Š éƒ¨ç½²ç›£æ§

## å¥åº·æª¢æŸ¥ç«¯é»
```typescript
// /health - Liveness probe
app.get('/health', (req, res) => {
  res.status(200).json({
    status: 'healthy',
    timestamp: new Date().toISOString()
  })
})

// /ready - Readiness probe
app.get('/ready', async (req, res) => {
  try {
    // æª¢æŸ¥ä¾è³´æœå‹™
    await db.query('SELECT 1')
    await redis.ping()

    res.status(200).json({
      status: 'ready',
      services: {
        database: 'connected',
        cache: 'connected'
      }
    })
  } catch (error) {
    res.status(503).json({
      status: 'not ready',
      error: error.message
    })
  }
})
```

## ç›£æ§æŒ‡æ¨™
```yaml
Metrics to Monitor:
  - Deployment frequency
  - Lead time for changes
  - Mean time to recovery (MTTR)
  - Change failure rate
  - Application performance (APM)
  - Error rates
  - Resource utilization
  - User experience metrics
```

# ğŸ”„ å›æ»¾ç­–ç•¥

## å¿«é€Ÿå›æ»¾
```bash
# Kubernetes å›æ»¾
kubectl rollout undo deployment/app-deployment

# Docker Compose å›æ»¾
docker-compose down
docker-compose up -d --scale app=0
docker tag app:previous app:current
docker-compose up -d

# Git å›æ»¾
git revert HEAD
git push origin main

# Feature Flag å›æ»¾
curl -X POST https://api.example.com/flags \
  -d '{"feature": "new-feature", "enabled": false}'
```

# ğŸ“‹ éƒ¨ç½²æª¢æŸ¥æ¸…å–®

## Pre-Deployment
- [ ] æ‰€æœ‰æ¸¬è©¦é€šé
- [ ] Code review å®Œæˆ
- [ ] å®‰å…¨æƒæé€šé
- [ ] è³‡æ–™åº«é·ç§»æº–å‚™å°±ç·’
- [ ] å›æ»¾è¨ˆåŠƒç¢ºèª
- [ ] ç›£æ§è­¦å ±è¨­å®š

## During Deployment
- [ ] å‚™ä»½ç•¶å‰ç‰ˆæœ¬
- [ ] åŸ·è¡Œè³‡æ–™åº«é·ç§»
- [ ] éƒ¨ç½²æ–°ç‰ˆæœ¬
- [ ] å¥åº·æª¢æŸ¥é€šé
- [ ] ç…™éœ§æ¸¬è©¦é€šé
- [ ] ç›£æ§æŒ‡æ¨™æ­£å¸¸

## Post-Deployment
- [ ] ç”¨æˆ¶é©—æ”¶æ¸¬è©¦
- [ ] æ•ˆèƒ½æŒ‡æ¨™ç¢ºèª
- [ ] éŒ¯èª¤ç‡ç›£æ§
- [ ] æ–‡æª”æ›´æ–°
- [ ] åœ˜éšŠé€šçŸ¥
- [ ] äº‹å¾Œæª¢è¨å®‰æ’

# ğŸš« éƒ¨ç½²ç¦å¿Œ

## çµ•å°ä¸å¯ä»¥
- âŒ é€±äº”ä¸‹åˆéƒ¨ç½²
- âŒ æ²’æœ‰å›æ»¾è¨ˆåŠƒå°±éƒ¨ç½²
- âŒ è·³éæ¸¬è©¦ç›´æ¥éƒ¨ç½²
- âŒ åœ¨ç”Ÿç”¢ç’°å¢ƒç›´æ¥ä¿®æ”¹
- âŒ ä½¿ç”¨ latest tag éƒ¨ç½²
- âŒ å¿½ç•¥å¥åº·æª¢æŸ¥å¤±æ•—

## å¿…é ˆè¦åš
- âœ… ä½¿ç”¨ä¸å¯è®ŠåŸºç¤è¨­æ–½
- âœ… å¯¦æ–½é›¶åœæ©Ÿéƒ¨ç½²
- âœ… è‡ªå‹•åŒ–æ‰€æœ‰æ­¥é©Ÿ
- âœ… è¨˜éŒ„æ‰€æœ‰è®Šæ›´
- âœ… æ¸¬è©¦å›æ»¾æµç¨‹
- âœ… ç›£æ§é—œéµæŒ‡æ¨™