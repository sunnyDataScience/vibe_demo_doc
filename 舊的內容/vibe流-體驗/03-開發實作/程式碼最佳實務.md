# ğŸ’ ç¨‹å¼ç¢¼æœ€ä½³å¯¦å‹™ï¼šå¯«å¥½ç¨‹å¼çš„æŠ€å·§

## ğŸ¯ ç‚ºä»€éº¼ç¨‹å¼ç¢¼å“è³ªå¾ˆé‡è¦ï¼Ÿ
å°±åƒå¯«æ–‡ç« ä¸€æ¨£ï¼Œç¨‹å¼ç¢¼ä¹Ÿéœ€è¦æ¸…æ¥šæ˜“æ‡‚ã€‚å¥½çš„ç¨‹å¼ç¢¼è®“åœ˜éšŠå”ä½œæ›´é †æš¢ï¼Œç¶­è­·æ›´ç°¡å–®ï¼Œbugæ›´å°‘ã€‚

## ğŸ“ å‘½åè¦å‰‡ï¼šè®“ç¨‹å¼ç¢¼æœƒèªªè©±

### ğŸ”¤ è®Šæ•¸å‘½ååŸå‰‡
**ç”¨æœ‰æ„ç¾©çš„åå­—ï¼Œè®“åˆ¥äººä¸€çœ‹å°±æ‡‚**

```javascript
// âŒ ä¸å¥½çš„å‘½å
const d = new Date();
const u = getUserData();
const temp = calculateSummary(data);

// âœ… å¥½çš„å‘½å
const currentDate = new Date();
const userData = getUserData();
const summaryResult = calculateSummary(articleData);
```

### ğŸ¯ å‡½æ•¸å‘½åè¦å‰‡
**å‹•è©é–‹é ­ï¼Œèªªæ˜å‡½æ•¸åšä»€éº¼**

```javascript
// âœ… æ¸…æ¥šçš„å‡½æ•¸åç¨±
function validateEmailFormat(email) { }
function calculateEstimatedTime(taskCount) { }
function sendNotificationToUser(userId, message) { }

// âŒ æ¨¡ç³Šçš„å‡½æ•¸åç¨±
function check(data) { }
function process(input) { }
function handle(request) { }
```

### ğŸ·ï¸ å¸¸æ•¸å‘½åè¦å‰‡
**å¤§å¯«å­—æ¯åŠ åº•ç·šï¼Œè¡¨ç¤ºä¸æœƒæ”¹è®Šçš„å€¼**

```javascript
// âœ… å¥½çš„å¸¸æ•¸å‘½å
const MAX_RETRY_COUNT = 3;
const API_BASE_URL = 'https://api.example.com';
const DEFAULT_SUMMARY_LENGTH = 'medium';

// é…ç½®å°è±¡ä¹Ÿå¯ä»¥ç”¨é§å³°å‘½å
const appConfig = {
    maxFileSize: 10 * 1024 * 1024,  // 10MB
    supportedLanguages: ['zh-TW', 'en-US'],
    defaultTimeout: 30000
};
```

## ğŸ—ï¸ å‡½æ•¸è¨­è¨ˆåŸå‰‡

### ğŸ¯ å–®ä¸€è·è²¬åŸå‰‡
**ä¸€å€‹å‡½æ•¸åªåšä¸€ä»¶äº‹ï¼Œåšå¥½ä¸€ä»¶äº‹**

```javascript
// âŒ å‡½æ•¸åšå¤ªå¤šäº‹æƒ…
function processNewsData(urls) {
    // é©—è­‰è¼¸å…¥
    if (!urls || !Array.isArray(urls)) {
        throw new Error('Invalid input');
    }

    // æŠ“å–å…§å®¹
    const articles = [];
    for (const url of urls) {
        const response = fetch(url);
        const html = response.text();
        const content = parseHtml(html);
        articles.push(content);
    }

    // ç”Ÿæˆæ‘˜è¦
    const summaryText = callAIService(articles);

    // ç”ŸæˆèªéŸ³
    const audioUrl = textToSpeech(summaryText);

    // å„²å­˜çµæœ
    saveToDatabase({ summaryText, audioUrl });

    return { summaryText, audioUrl };
}

// âœ… æ‹†åˆ†æˆå¤šå€‹å°ˆè·å‡½æ•¸
async function validateUrls(urls) {
    if (!urls || !Array.isArray(urls)) {
        throw new Error('URLs must be a valid array');
    }

    if (urls.length === 0) {
        throw new Error('At least one URL is required');
    }

    const urlPattern = /^https?:\\/\\/.+/;
    const invalidUrls = urls.filter(url => !urlPattern.test(url));

    if (invalidUrls.length > 0) {
        throw new Error(`Invalid URLs: ${invalidUrls.join(', ')}`);
    }
}

async function fetchArticles(urls) {
    const articles = [];

    for (const url of urls) {
        try {
            const article = await fetchSingleArticle(url);
            articles.push(article);
        } catch (error) {
            console.warn(`Failed to fetch ${url}:`, error.message);
        }
    }

    return articles;
}

async function generateSummary(articles, customPrompt) {
    if (articles.length === 0) {
        throw new Error('No articles available for summarization');
    }

    return await AIService.summarize(articles, customPrompt);
}

// ä¸»è¦çš„å”èª¿å‡½æ•¸
async function processNewsTask(urls, customPrompt) {
    await validateUrls(urls);
    const articles = await fetchArticles(urls);
    const summaryText = await generateSummary(articles, customPrompt);
    const audioUrl = await VoiceService.textToSpeech(summaryText);

    return { summaryText, audioUrl, articleCount: articles.length };
}
```

### ğŸ“ å‡½æ•¸å¤§å°æ§åˆ¶
**ä¸€å€‹å‡½æ•¸æœ€å¥½ä¸è¶…é20-30è¡Œ**

```javascript
// âœ… ç°¡æ½”çš„å‡½æ•¸
function formatSummaryForDisplay(summary, maxLength = 200) {
    if (!summary || typeof summary !== 'string') {
        return 'æš«ç„¡æ‘˜è¦å…§å®¹';
    }

    if (summary.length <= maxLength) {
        return summary;
    }

    return summary.substring(0, maxLength) + '...';
}

// âœ… è¤‡é›œé‚è¼¯æ‹†åˆ†æˆå¤šå€‹å°å‡½æ•¸
function createTaskFromUserInput() {
    const rawInput = collectUserInput();
    const validatedInput = validateTaskInput(rawInput);
    const taskConfig = buildTaskConfiguration(validatedInput);

    return taskConfig;
}

function collectUserInput() {
    return {
        urls: getUrlsFromTextarea(),
        prompt: getSelectedPromptType(),
        schedule: getScheduleSettings()
    };
}

function validateTaskInput(input) {
    validateUrls(input.urls);
    validatePrompt(input.prompt);
    validateSchedule(input.schedule);

    return input;
}
```

## ğŸ›¡ï¸ éŒ¯èª¤è™•ç†ç­–ç•¥

### ğŸ¯ æ˜ç¢ºçš„éŒ¯èª¤é¡å‹
**ç”¨è‡ªå®šç¾©éŒ¯èª¤é¡å‹ï¼Œè®“éŒ¯èª¤ä¿¡æ¯æ›´æœ‰ç”¨**

```javascript
// å®šç¾©å°ˆé–€çš„éŒ¯èª¤é¡å‹
class ValidationError extends Error {
    constructor(message, field = null) {
        super(message);
        this.name = 'ValidationError';
        this.field = field;
    }
}

class NetworkError extends Error {
    constructor(message, url = null, statusCode = null) {
        super(message);
        this.name = 'NetworkError';
        this.url = url;
        this.statusCode = statusCode;
    }
}

class AIServiceError extends Error {
    constructor(message, details = null) {
        super(message);
        this.name = 'AIServiceError';
        this.details = details;
    }
}

// ä½¿ç”¨è‡ªå®šç¾©éŒ¯èª¤
function validateEmail(email) {
    if (!email) {
        throw new ValidationError('éƒµä»¶åœ°å€ä¸èƒ½ç‚ºç©º', 'email');
    }

    if (!email.includes('@')) {
        throw new ValidationError('éƒµä»¶åœ°å€æ ¼å¼ä¸æ­£ç¢º', 'email');
    }
}

async function fetchArticleContent(url) {
    try {
        const response = await fetch(url);

        if (!response.ok) {
            throw new NetworkError(
                `ç„¡æ³•ç²å–ç¶²é å…§å®¹: ${response.statusText}`,
                url,
                response.status
            );
        }

        return await response.text();
    } catch (error) {
        if (error instanceof NetworkError) {
            throw error;
        }

        throw new NetworkError(
            `ç¶²è·¯é€£æ¥å¤±æ•—: ${error.message}`,
            url
        );
    }
}
```

### ğŸ”„ å„ªé›…çš„éŒ¯èª¤æ¢å¾©
**çµ¦ç”¨æˆ¶æä¾›æœ‰ç”¨çš„éŒ¯èª¤ä¿¡æ¯å’Œæ¢å¾©å»ºè­°**

```javascript
class TaskProcessor {
    async processWithRetry(taskData, maxRetries = 3) {
        let lastError;

        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                console.log(`å˜—è©¦è™•ç†ä»»å‹™ (ç¬¬${attempt}æ¬¡)`);
                return await this.processTask(taskData);

            } catch (error) {
                lastError = error;

                if (this.isRetryableError(error) && attempt < maxRetries) {
                    const delay = this.calculateRetryDelay(attempt);
                    console.log(`è™•ç†å¤±æ•—ï¼Œ${delay/1000}ç§’å¾Œé‡è©¦...`);
                    await this.sleep(delay);
                    continue;
                }

                break;
            }
        }

        // æ‰€æœ‰é‡è©¦éƒ½å¤±æ•—äº†
        throw new Error(`ä»»å‹™è™•ç†å¤±æ•— (å˜—è©¦${maxRetries}æ¬¡): ${lastError.message}`);
    }

    isRetryableError(error) {
        // ç¶²è·¯éŒ¯èª¤å’Œæš«æ™‚æ€§æœå‹™éŒ¯èª¤å¯ä»¥é‡è©¦
        return error instanceof NetworkError ||
               error.message.includes('timeout') ||
               error.message.includes('rate limit');
    }

    calculateRetryDelay(attempt) {
        // æŒ‡æ•¸é€€é¿ï¼š1ç§’, 2ç§’, 4ç§’...
        return Math.pow(2, attempt - 1) * 1000;
    }

    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// ç”¨æˆ¶å‹å–„çš„éŒ¯èª¤è™•ç†
function handleTaskError(error, showToUser) {
    let userMessage = '';
    let shouldRetry = false;

    if (error instanceof ValidationError) {
        userMessage = `è¼¸å…¥é©—è­‰å¤±æ•—: ${error.message}`;
        showRetryButton = false;
    } else if (error instanceof NetworkError) {
        userMessage = 'ç¶²è·¯é€£æ¥æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦';
        shouldRetry = true;
    } else if (error instanceof AIServiceError) {
        userMessage = 'AIæœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œé‡è©¦';
        shouldRetry = true;
    } else {
        userMessage = 'ç³»çµ±ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼Œè«‹è¯ç¹«å®¢æœ';
        shouldRetry = true;
    }

    showToUser({
        message: userMessage,
        type: 'error',
        showRetryButton: shouldRetry
    });

    // è¨˜éŒ„è©³ç´°éŒ¯èª¤ç”¨æ–¼é™¤éŒ¯
    console.error('Task processing error:', {
        name: error.name,
        message: error.message,
        stack: error.stack,
        timestamp: new Date().toISOString()
    });
}
```

## ğŸ§¹ ç¨‹å¼ç¢¼æ•´æ½”åŸå‰‡

### ğŸ“ è¨»è§£çš„è—è¡“
**ä¸è¦è§£é‡‹ç¨‹å¼ç¢¼æ€éº¼åšï¼Œè¦è§£é‡‹ç‚ºä»€éº¼é€™æ¨£åš**

```javascript
// âŒ ç„¡ç”¨çš„è¨»è§£
// å°‡iè¨­ç‚º0
let i = 0;

// å¾ªç’°éæ­·æ•¸çµ„
for (let item of items) {
    // è™•ç†æ¯ä¸€é …
    process(item);
}

// âœ… æœ‰ç”¨çš„è¨»è§£
// ç‚ºäº†é¿å…APIé€Ÿç‡é™åˆ¶ï¼Œæˆ‘å€‘éœ€è¦åœ¨è«‹æ±‚ä¹‹é–“å¢åŠ å»¶é²
const CRAWL_DELAY_MS = 1000;

// OpenAI APIé™åˆ¶æ¯åˆ†é˜æœ€å¤š60æ¬¡è«‹æ±‚ï¼Œç‚ºäº†å®‰å…¨èµ·è¦‹è¨­ç‚º50
const MAX_REQUESTS_PER_MINUTE = 50;

/**
 * æ ¹æ“šæ–‡ç« å…§å®¹çš„è¤‡é›œåº¦å‹•æ…‹èª¿æ•´AIæ¨¡å‹åƒæ•¸
 *
 * ç°¡å–®æ–‡ç« ä½¿ç”¨è¼ƒä½çš„temperatureä»¥ç¢ºä¿ä¸€è‡´æ€§
 * è¤‡é›œæ–‡ç« ä½¿ç”¨è¼ƒé«˜çš„temperatureä»¥æé«˜å‰µé€ æ€§
 *
 * @param {Array} articles - è¦æ‘˜è¦çš„æ–‡ç« åˆ—è¡¨
 * @returns {Object} AIæ¨¡å‹é…ç½®
 */
function calculateAIParameters(articles) {
    const avgWordCount = calculateAverageWordCount(articles);
    const complexity = assessContentComplexity(articles);

    return {
        temperature: complexity > 0.7 ? 0.8 : 0.3,
        maxTokens: Math.min(avgWordCount * 0.3, 500)
    };
}
```

### ğŸ¨ ç¨‹å¼ç¢¼æ ¼å¼åŒ–
**ä¸€è‡´çš„æ ¼å¼è®“ç¨‹å¼ç¢¼æ›´æ˜“è®€**

```javascript
// âœ… è‰¯å¥½çš„æ ¼å¼åŒ–
class NewsExtension {
    constructor(apiBaseUrl) {
        this.apiBaseUrl = apiBaseUrl;
        this.taskCache = new Map();
        this.retryConfig = {
            maxAttempts: 3,
            baseDelayMs: 1000
        };
    }

    async createSummaryTask(taskData) {
        // é©—è­‰è¼¸å…¥æ•¸æ“š
        this.validateTaskData(taskData);

        // ç”Ÿæˆä»»å‹™ID
        const taskId = this.generateTaskId();

        // ç™¼é€å‰µå»ºè«‹æ±‚
        const response = await this.sendApiRequest({
            endpoint: '/tasks',
            method: 'POST',
            data: {
                taskId,
                ...taskData
            }
        });

        // å¿«å–ä»»å‹™ä¿¡æ¯
        this.taskCache.set(taskId, {
            status: 'pending',
            createdAt: new Date()
        });

        return response;
    }

    validateTaskData(taskData) {
        const { urls, customPrompt } = taskData;

        if (!Array.isArray(urls) || urls.length === 0) {
            throw new ValidationError('å¿…é ˆæä¾›è‡³å°‘ä¸€å€‹URL');
        }

        if (urls.length > 10) {
            throw new ValidationError('ä¸€æ¬¡æœ€å¤šåªèƒ½è™•ç†10å€‹URL');
        }

        if (customPrompt && customPrompt.length > 1000) {
            throw new ValidationError('è‡ªå®šç¾©æç¤ºè©ä¸èƒ½è¶…é1000å­—ç¬¦');
        }
    }
}
```

### ğŸ”„ é¿å…é‡è¤‡ä»£ç¢¼ (DRYåŸå‰‡)
**Don't Repeat Yourself - ç›¸åŒçš„é‚è¼¯åªå¯«ä¸€æ¬¡**

```javascript
// âŒ é‡è¤‡çš„ä»£ç¢¼
function validateTaskUrls(urls) {
    if (!urls || !Array.isArray(urls)) {
        throw new Error('URLs must be an array');
    }
    if (urls.length === 0) {
        throw new Error('At least one URL is required');
    }
    for (const url of urls) {
        if (!url.startsWith('http')) {
            throw new Error('All URLs must start with http or https');
        }
    }
}

function validateUserUrls(urls) {
    if (!urls || !Array.isArray(urls)) {
        throw new Error('URLs must be an array');
    }
    if (urls.length === 0) {
        throw new Error('At least one URL is required');
    }
    for (const url of urls) {
        if (!url.startsWith('http')) {
            throw new Error('All URLs must start with http or https');
        }
    }
}

// âœ… æå–å…¬å…±é‚è¼¯
class URLValidator {
    static validate(urls, options = {}) {
        const {
            required = true,
            maxCount = 10,
            allowedProtocols = ['http:', 'https:']
        } = options;

        if (!urls || !Array.isArray(urls)) {
            throw new ValidationError('URLs must be an array');
        }

        if (required && urls.length === 0) {
            throw new ValidationError('At least one URL is required');
        }

        if (urls.length > maxCount) {
            throw new ValidationError(`Too many URLs, maximum is ${maxCount}`);
        }

        for (const url of urls) {
            this.validateSingleUrl(url, allowedProtocols);
        }
    }

    static validateSingleUrl(url, allowedProtocols) {
        if (!url || typeof url !== 'string') {
            throw new ValidationError('URL must be a non-empty string');
        }

        let parsedUrl;
        try {
            parsedUrl = new URL(url);
        } catch {
            throw new ValidationError(`Invalid URL format: ${url}`);
        }

        if (!allowedProtocols.includes(parsedUrl.protocol)) {
            throw new ValidationError(
                `URL must use one of: ${allowedProtocols.join(', ')}`
            );
        }
    }
}

// ä½¿ç”¨çµ±ä¸€çš„é©—è­‰å™¨
function validateTaskUrls(urls) {
    URLValidator.validate(urls, { maxCount: 10 });
}

function validateUserUrls(urls) {
    URLValidator.validate(urls, { maxCount: 5 });
}
```

## ğŸ§ª æ¸¬è©¦å‹å–„çš„ä»£ç¢¼

### ğŸ¯ å¯æ¸¬è©¦çš„å‡½æ•¸è¨­è¨ˆ
**é¿å…å‰¯ä½œç”¨ï¼Œè®“å‡½æ•¸å®¹æ˜“æ¸¬è©¦**

```javascript
// âŒ é›£ä»¥æ¸¬è©¦çš„å‡½æ•¸
function processNews() {
    const urls = document.getElementById('urls').value.split('\\n');
    const data = fetch('/api/news').then(r => r.json());
    const result = callAI(data);

    document.getElementById('result').innerHTML = result;
    localStorage.setItem('lastResult', result);

    return result;
}

// âœ… å®¹æ˜“æ¸¬è©¦çš„å‡½æ•¸
function parseUrlInput(urlText) {
    if (!urlText || typeof urlText !== 'string') {
        return [];
    }

    return urlText
        .split('\\n')
        .map(url => url.trim())
        .filter(url => url.length > 0);
}

async function fetchNewsData(urls) {
    const results = [];

    for (const url of urls) {
        try {
            const data = await fetch(`/api/news?url=${encodeURIComponent(url)}`);
            const json = await data.json();
            results.push(json);
        } catch (error) {
            console.warn(`Failed to fetch ${url}:`, error);
        }
    }

    return results;
}

function formatSummaryResult(summary, metadata = {}) {
    return {
        content: summary,
        wordCount: summary.length,
        generatedAt: metadata.timestamp || new Date().toISOString(),
        model: metadata.model || 'unknown'
    };
}

// ä¸»è¦çš„å”èª¿å‡½æ•¸
async function processNewsWorkflow(urlText) {
    const urls = parseUrlInput(urlText);
    const newsData = await fetchNewsData(urls);
    const summary = await generateSummary(newsData);

    return formatSummaryResult(summary, {
        timestamp: new Date().toISOString(),
        model: 'gpt-3.5-turbo'
    });
}
```

### ğŸ“‹ å¸¸æ•¸é…ç½®å¤–éƒ¨åŒ–
**æŠŠé…ç½®æå–å‡ºä¾†ï¼Œæ–¹ä¾¿æ¸¬è©¦å’Œèª¿æ•´**

```javascript
// é…ç½®æ–‡ä»¶: config/app.js
const config = {
    api: {
        baseUrl: process.env.API_BASE_URL || 'http://localhost:3000',
        timeout: 30000,
        retryAttempts: 3
    },

    ai: {
        model: 'gpt-3.5-turbo',
        maxTokens: 500,
        temperature: 0.7
    },

    limits: {
        maxUrls: 10,
        maxPromptLength: 1000,
        maxSummaryLength: 2000
    },

    cache: {
        ttl: 3600000, // 1å°æ™‚
        maxSize: 100
    }
};

module.exports = config;

// ä½¿ç”¨é…ç½®
const config = require('./config/app');

class AIService {
    static async generateSummary(articles, customPrompt) {
        const response = await fetch(`${config.api.baseUrl}/ai/summarize`, {
            method: 'POST',
            timeout: config.api.timeout,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                articles,
                prompt: customPrompt,
                model: config.ai.model,
                maxTokens: config.ai.maxTokens,
                temperature: config.ai.temperature
            })
        });

        return await response.json();
    }
}
```

---
*è¨˜ä½ï¼šå¯«ç¨‹å¼ç¢¼å°±åƒå¯«æ–‡ç« ï¼Œæ¸…æ¥šã€ç°¡æ½”ã€æœ‰é‚è¼¯çš„ä»£ç¢¼æ˜¯æœ€å¥½çš„ä»£ç¢¼ï¼*