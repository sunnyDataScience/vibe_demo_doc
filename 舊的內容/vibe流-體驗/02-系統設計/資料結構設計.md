# ğŸ—„ï¸ è³‡æ–™çµæ§‹è¨­è¨ˆï¼šè³‡æ–™åº«å’ŒAPIè¨­è¨ˆ

## ğŸ¯ ä»€éº¼æ˜¯è³‡æ–™çµæ§‹è¨­è¨ˆï¼Ÿ
å°±åƒè¨­è¨ˆæˆ¿å±‹çš„æ”¶ç´ç³»çµ±ä¸€æ¨£ï¼Œæˆ‘å€‘éœ€è¦è¦åŠƒå¦‚ä½•æœ‰æ•ˆåœ°å„²å­˜ã€çµ„ç¹”å’Œå–ç”¨è³‡æ–™ã€‚å¥½çš„è³‡æ–™çµæ§‹è®“ç³»çµ±é‹è¡Œæ›´å¿«ã€æ›´ç©©å®šã€‚

## ğŸ“Š è³‡æ–™åº«è¨­è¨ˆ

### ğŸ—ï¸ æ•´é«”è³‡æ–™æ¶æ§‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æ™ºèƒ½æ–°èæ‘˜è¦ç³»çµ±                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ¶ç›¸é—œè³‡æ–™    â”‚  ä»»å‹™ç›¸é—œè³‡æ–™  â”‚  ç³»çµ±è³‡æ–™  â”‚
â”‚  â”œâ”€ Users       â”‚ â”œâ”€ Tasks      â”‚ â”œâ”€ Logs   â”‚
â”‚  â”œâ”€ Preferences â”‚ â”œâ”€ Results    â”‚ â”œâ”€ Config â”‚
â”‚  â””â”€ Sessions    â”‚ â””â”€ Schedules  â”‚ â””â”€ Stats  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“‹ æ ¸å¿ƒè³‡æ–™è¡¨è¨­è¨ˆ

#### 1. ç”¨æˆ¶è¡¨ (Users)
```sql
CREATE TABLE users (
    user_id         VARCHAR(36) PRIMARY KEY,    -- UUID
    email          VARCHAR(255) UNIQUE NOT NULL,
    name           VARCHAR(100) NOT NULL,
    created_at     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login     TIMESTAMP,
    status         ENUM('active', 'inactive', 'suspended') DEFAULT 'active',

    -- ç´¢å¼•å„ªåŒ–
    INDEX idx_email (email),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);
```

**æ¬„ä½èªªæ˜**ï¼š
- `user_id`: ç”¨æˆ¶å”¯ä¸€è­˜åˆ¥ç¢¼ï¼Œä½¿ç”¨UUIDç¢ºä¿å…¨çƒå”¯ä¸€
- `email`: ç”¨æˆ¶é›»å­éƒµä»¶ï¼Œä½œç‚ºç™»å…¥æ†‘è­‰
- `status`: ç”¨æˆ¶ç‹€æ…‹ç®¡ç†ï¼Œæ”¯æ´å¸³è™Ÿåœç”¨ç­‰åŠŸèƒ½

#### 2. ç”¨æˆ¶åå¥½è¨­å®šè¡¨ (User_Preferences)
```sql
CREATE TABLE user_preferences (
    preference_id   VARCHAR(36) PRIMARY KEY,
    user_id        VARCHAR(36) NOT NULL,

    -- æ‘˜è¦åå¥½è¨­å®š
    summary_length  ENUM('short', 'medium', 'long') DEFAULT 'medium',
    summary_style   ENUM('business', 'technical', 'casual') DEFAULT 'business',
    language       VARCHAR(10) DEFAULT 'zh-TW',

    -- èªéŸ³è¨­å®š
    voice_enabled   BOOLEAN DEFAULT true,
    voice_speed     ENUM('slow', 'normal', 'fast') DEFAULT 'normal',
    voice_gender    ENUM('male', 'female') DEFAULT 'female',

    -- é€šçŸ¥è¨­å®š
    email_notification  BOOLEAN DEFAULT true,
    push_notification   BOOLEAN DEFAULT true,

    created_at     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id)
);
```

#### 3. æ‘˜è¦ä»»å‹™è¡¨ (Summary_Tasks)
```sql
CREATE TABLE summary_tasks (
    task_id        VARCHAR(36) PRIMARY KEY,
    user_id        VARCHAR(36) NOT NULL,

    -- ä»»å‹™é…ç½®
    title          VARCHAR(200),
    urls           JSON NOT NULL,              -- å„²å­˜ç¶²å€é™£åˆ—
    custom_prompt  TEXT,                       -- ç”¨æˆ¶è‡ªå®šç¾©æç¤ºè©

    -- æ’ç¨‹è¨­å®š
    schedule_type  ENUM('immediate', 'once', 'daily', 'weekly') DEFAULT 'immediate',
    scheduled_at   TIMESTAMP,
    timezone       VARCHAR(50) DEFAULT 'Asia/Taipei',

    -- ä»»å‹™ç‹€æ…‹
    status         ENUM('pending', 'processing', 'completed', 'failed', 'cancelled') DEFAULT 'pending',
    retry_count    INT DEFAULT 0,
    max_retries    INT DEFAULT 3,

    -- æ™‚é–“è¨˜éŒ„
    created_at     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    started_at     TIMESTAMP,
    completed_at   TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_scheduled_at (scheduled_at),
    INDEX idx_created_at (created_at)
);
```

#### 4. æ‘˜è¦çµæœè¡¨ (Summary_Results)
```sql
CREATE TABLE summary_results (
    result_id      VARCHAR(36) PRIMARY KEY,
    task_id        VARCHAR(36) NOT NULL,

    -- æ‘˜è¦å…§å®¹
    summary_text   TEXT NOT NULL,
    original_urls  JSON,                       -- åŸå§‹ç¶²å€æ¸…å–®
    references     JSON,                       -- åƒè€ƒè³‡æ–™é€£çµ

    -- èªéŸ³æª”æ¡ˆ
    audio_url      VARCHAR(500),
    audio_duration INT,                        -- èªéŸ³é•·åº¦(ç§’)

    -- å…ƒæ•¸æ“š
    word_count     INT,
    processing_time_ms INT,
    ai_model_used  VARCHAR(100),

    created_at     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (task_id) REFERENCES summary_tasks(task_id) ON DELETE CASCADE,
    INDEX idx_task_id (task_id),
    INDEX idx_created_at (created_at)
);
```

#### 5. çˆ¬èŸ²å…§å®¹å¿«å–è¡¨ (Content_Cache)
```sql
CREATE TABLE content_cache (
    cache_id       VARCHAR(36) PRIMARY KEY,
    url           VARCHAR(2000) NOT NULL,
    url_hash      VARCHAR(64) NOT NULL,       -- URLçš„hashå€¼ï¼Œæå‡æŸ¥è©¢æ•ˆèƒ½

    -- å…§å®¹è³‡æ–™
    title         VARCHAR(500),
    content       TEXT,
    published_at  TIMESTAMP,

    -- å¿«å–ç®¡ç†
    cached_at     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at    TIMESTAMP,
    hit_count     INT DEFAULT 0,

    UNIQUE KEY uk_url_hash (url_hash),
    INDEX idx_url (url(255)),
    INDEX idx_expires_at (expires_at)
);
```

#### 6. ç³»çµ±æ—¥èªŒè¡¨ (System_Logs)
```sql
CREATE TABLE system_logs (
    log_id        BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id       VARCHAR(36),
    task_id       VARCHAR(36),

    -- æ—¥èªŒå…§å®¹
    level         ENUM('debug', 'info', 'warning', 'error', 'fatal') NOT NULL,
    message       TEXT NOT NULL,
    context       JSON,                        -- é¡å¤–çš„ä¸Šä¸‹æ–‡è³‡è¨Š

    -- ä¾†æºè³‡è¨Š
    component     VARCHAR(100),                -- ç”¢ç”Ÿæ—¥èªŒçš„çµ„ä»¶åç¨±
    ip_address    VARCHAR(45),                 -- ç”¨æˆ¶IPåœ°å€
    user_agent    VARCHAR(500),                -- ç€è¦½å™¨è³‡è¨Š

    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_level (level),
    INDEX idx_created_at (created_at),
    INDEX idx_user_id (user_id),
    INDEX idx_component (component)
);
```

## ğŸ”Œ API è¨­è¨ˆ

### ğŸ¯ RESTful API è¨­è¨ˆåŸå‰‡

#### 1. è³‡æºå‘½åè¦ç¯„
```
GET    /api/v1/users/{userId}              # å–å¾—ç”¨æˆ¶è³‡æ–™
PUT    /api/v1/users/{userId}              # æ›´æ–°ç”¨æˆ¶è³‡æ–™
DELETE /api/v1/users/{userId}              # åˆªé™¤ç”¨æˆ¶

GET    /api/v1/users/{userId}/tasks        # å–å¾—ç”¨æˆ¶çš„ä»»å‹™æ¸…å–®
POST   /api/v1/users/{userId}/tasks        # å‰µå»ºæ–°ä»»å‹™
GET    /api/v1/tasks/{taskId}              # å–å¾—ç‰¹å®šä»»å‹™
PUT    /api/v1/tasks/{taskId}              # æ›´æ–°ä»»å‹™
DELETE /api/v1/tasks/{taskId}              # åˆªé™¤ä»»å‹™

GET    /api/v1/tasks/{taskId}/result       # å–å¾—æ‘˜è¦çµæœ
```

#### 2. HTTP ç‹€æ…‹ç¢¼ä½¿ç”¨
```
200 OK           - è«‹æ±‚æˆåŠŸ
201 Created      - è³‡æºå‰µå»ºæˆåŠŸ
204 No Content   - æˆåŠŸä½†ç„¡å›å‚³å…§å®¹
400 Bad Request  - è«‹æ±‚æ ¼å¼éŒ¯èª¤
401 Unauthorized - æœªèªè­‰
403 Forbidden    - ç„¡æ¬Šé™
404 Not Found    - è³‡æºä¸å­˜åœ¨
409 Conflict     - è³‡æºè¡çª
422 Unprocessable Entity - é©—è­‰å¤±æ•—
429 Too Many Requests - è«‹æ±‚éæ–¼é »ç¹
500 Internal Server Error - ä¼ºæœå™¨éŒ¯èª¤
```

### ğŸ“ API è©³ç´°è¦æ ¼

#### 1. å‰µå»ºæ‘˜è¦ä»»å‹™ API
```http
POST /api/v1/tasks
Content-Type: application/json
Authorization: Bearer {token}

{
  \"urls\": [
    \"https://example.com/news1\",
    \"https://example.com/news2\"
  ],
  \"title\": \"ä»Šæ—¥ç§‘æŠ€æ–°èæ‘˜è¦\",
  \"customPrompt\": \"è«‹ç”¨å•†æ¥­åˆ†æçš„è§’åº¦æ•´ç†é€™äº›æ–°è\",
  \"scheduleType\": \"immediate\",
  \"preferences\": {
    \"summaryLength\": \"medium\",
    \"voiceEnabled\": true,
    \"language\": \"zh-TW\"
  }
}
```

**æˆåŠŸå›æ‡‰ (201 Created):**
```json
{
  \"success\": true,
  \"data\": {
    \"taskId\": \"550e8400-e29b-41d4-a716-446655440000\",
    \"status\": \"pending\",
    \"estimatedCompletionTime\": \"2024-01-15T10:30:00Z\",
    \"message\": \"ä»»å‹™å·²æˆåŠŸå‰µå»ºï¼Œé è¨ˆ3åˆ†é˜å…§å®Œæˆ\"
  }
}
```

**éŒ¯èª¤å›æ‡‰ (400 Bad Request):**
```json
{
  \"success\": false,
  \"error\": {
    \"code\": \"INVALID_URL\",
    \"message\": \"æä¾›çš„ç¶²å€æ ¼å¼ä¸æ­£ç¢º\",
    \"details\": [
      {
        \"field\": \"urls[0]\",
        \"message\": \"ä¸æ˜¯æœ‰æ•ˆçš„URLæ ¼å¼\"
      }
    ]
  }
}
```

#### 2. æŸ¥è©¢ä»»å‹™çµæœ API
```http
GET /api/v1/tasks/{taskId}/result
Authorization: Bearer {token}
```

**æˆåŠŸå›æ‡‰ (200 OK):**
```json
{
  \"success\": true,
  \"data\": {
    \"taskId\": \"550e8400-e29b-41d4-a716-446655440000\",
    \"status\": \"completed\",
    \"result\": {
      \"summaryText\": \"ä»Šæ—¥ç§‘æŠ€æ–°èé‡é»æ‘˜è¦...\",
      \"audioUrl\": \"https://storage.example.com/audio/task_123.mp3\",
      \"audioDuration\": 180,
      \"references\": [
        {
          \"title\": \"ç§‘æŠ€æ–°èæ¨™é¡Œ1\",
          \"url\": \"https://example.com/news1\",
          \"publishedAt\": \"2024-01-15T08:00:00Z\"
        }
      ],
      \"metadata\": {
        \"wordCount\": 245,
        \"processingTimeMs\": 15000,
        \"aiModelUsed\": \"gpt-3.5-turbo\"
      }
    },
    \"completedAt\": \"2024-01-15T10:28:00Z\"
  }
}
```

#### 3. ç”¨æˆ¶åå¥½è¨­å®š API
```http
GET /api/v1/users/{userId}/preferences
PUT /api/v1/users/{userId}/preferences
Authorization: Bearer {token}
```

**æ›´æ–°åå¥½è¨­å®šè«‹æ±‚:**
```json
{
  \"summaryLength\": \"long\",
  \"summaryStyle\": \"technical\",
  \"language\": \"zh-TW\",
  \"voiceEnabled\": true,
  \"voiceSpeed\": \"normal\",
  \"emailNotification\": true
}
```

### ğŸ”’ API å®‰å…¨æ€§è¨­è¨ˆ

#### 1. èªè­‰èˆ‡æˆæ¬Š
```
Authentication: Bearer Token (JWT)
- Header: Authorization: Bearer {token}
- TokenåŒ…å«: userId, permissions, expiry
- TokenéæœŸæ™‚é–“: 24å°æ™‚
- Refresh Tokenæ©Ÿåˆ¶æ”¯æ´è‡ªå‹•å»¶æœŸ
```

#### 2. è«‹æ±‚é™åˆ¶ (Rate Limiting)
```
ä¸€èˆ¬API: æ¯åˆ†é˜100æ¬¡è«‹æ±‚
å‰µå»ºä»»å‹™: æ¯å°æ™‚10æ¬¡
æª”æ¡ˆä¸Šå‚³: æ¯åˆ†é˜5æ¬¡
```

#### 3. è¼¸å…¥é©—è­‰
```javascript
// URLé©—è­‰
const isValidUrl = (url) => {
  try {
    new URL(url);
    return url.startsWith('http://') || url.startsWith('https://');
  } catch {
    return false;
  }
};

// è‡ªå®šç¾©æç¤ºè©é©—è­‰
const validatePrompt = (prompt) => {
  return prompt.length <= 1000 && !containsMaliciousContent(prompt);
};
```

## ğŸ“Š è³‡æ–™åº«æ•ˆèƒ½å„ªåŒ–

### ğŸš€ ç´¢å¼•è¨­è¨ˆç­–ç•¥
```sql
-- è¤‡åˆç´¢å¼•ï¼šæ”¯æ´å¸¸è¦‹æŸ¥è©¢çµ„åˆ
CREATE INDEX idx_user_status_created ON summary_tasks(user_id, status, created_at);

-- éƒ¨åˆ†ç´¢å¼•ï¼šåªç´¢å¼•æ´»èºè³‡æ–™
CREATE INDEX idx_active_tasks ON summary_tasks(scheduled_at)
WHERE status IN ('pending', 'processing');

-- å‡½æ•¸ç´¢å¼•ï¼šæ”¯æ´ç‰¹æ®ŠæŸ¥è©¢
CREATE INDEX idx_task_date ON summary_tasks(DATE(created_at));
```

### ğŸ’¾ è³‡æ–™åˆ†å€ç­–ç•¥
```sql
-- æŒ‰æ™‚é–“åˆ†å€ï¼šæå‡æ­·å²è³‡æ–™æŸ¥è©¢æ•ˆèƒ½
CREATE TABLE summary_results (
    -- æ¬„ä½å®šç¾©...
) PARTITION BY RANGE (YEAR(created_at)) (
    PARTITION p2023 VALUES LESS THAN (2024),
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026)
);
```

### ğŸ—‘ï¸ è³‡æ–™æ¸…ç†ç­–ç•¥
```sql
-- è‡ªå‹•æ¸…ç†éæœŸçš„å¿«å–è³‡æ–™
DELETE FROM content_cache
WHERE expires_at < NOW() - INTERVAL 7 DAY;

-- æ­¸æª”èˆŠçš„æ—¥èªŒè³‡æ–™
INSERT INTO system_logs_archive
SELECT * FROM system_logs
WHERE created_at < NOW() - INTERVAL 90 DAY;
```

## ğŸ“‹ è³‡æ–™é©—è­‰è¦å‰‡

### ğŸ” è¼¸å…¥é©—è­‰
```json
{
  \"taskValidation\": {
    \"title\": {
      \"required\": false,
      \"maxLength\": 200,
      \"pattern\": \"^[\\u4e00-\\u9fa5a-zA-Z0-9\\s\\-_]+$\"
    },
    \"urls\": {
      \"required\": true,
      \"minItems\": 1,
      \"maxItems\": 10,
      \"itemType\": \"validUrl\"
    },
    \"customPrompt\": {
      \"required\": false,
      \"maxLength\": 1000,
      \"forbiddenPatterns\": [\"<script>\", \"javascript:\"]
    }
  }
}
```

### ğŸ›¡ï¸ è³‡æ–™å®Œæ•´æ€§ç´„æŸ
```sql
-- ç¢ºä¿ç‹€æ…‹è½‰æ›é‚è¼¯æ­£ç¢º
ALTER TABLE summary_tasks
ADD CONSTRAINT chk_status_logic
CHECK (
    (status = 'pending' AND started_at IS NULL) OR
    (status = 'processing' AND started_at IS NOT NULL) OR
    (status IN ('completed', 'failed') AND completed_at IS NOT NULL)
);

-- ç¢ºä¿é‡è©¦æ¬¡æ•¸åˆç†
ALTER TABLE summary_tasks
ADD CONSTRAINT chk_retry_count
CHECK (retry_count >= 0 AND retry_count <= max_retries);
```

## ğŸ”„ è³‡æ–™åŒæ­¥èˆ‡å‚™ä»½

### ğŸ“¤ è³‡æ–™å‚™ä»½ç­–ç•¥
```bash
# æ¯æ—¥å…¨é‡å‚™ä»½
mysqldump --single-transaction --routines --triggers news_summary > backup_$(date +%Y%m%d).sql

# å¢é‡å‚™ä»½ï¼šä½¿ç”¨binlog
mysqlbinlog --start-datetime=\"2024-01-15 00:00:00\" mysql-bin.000001
```

### ğŸ”„ è³‡æ–™åŒæ­¥æ©Ÿåˆ¶
```javascript
// ä¸»å¾è³‡æ–™åº«è®€å¯«åˆ†é›¢
const dbConfig = {
  write: { host: 'master.db.example.com' },
  read: { host: 'slave.db.example.com' }
};

// æ ¹æ“šæ“ä½œé¡å‹é¸æ“‡è³‡æ–™åº«
const getConnection = (operation) => {
  return operation === 'SELECT' ? dbConfig.read : dbConfig.write;
};
```

---
*å¥½çš„è³‡æ–™çµæ§‹è¨­è¨ˆæ˜¯ç³»çµ±ç©©å®šé‹è¡Œçš„åŸºçŸ³ï¼*