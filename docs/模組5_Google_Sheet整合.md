# 📦 模組5:Google Sheet整合(2小時)

## 🔍 第一性原理拆解

**核心知識點:API整合 (API Integration)**

```
最根本的問題:
「怎麼讓兩個不同的系統互相傳資料?」

生活類比:
├─ 郵局:寄信到指定地址→API呼叫
├─ 自動販賣機:投幣→取貨→API請求與回應
└─ 餐廳外送:下單→店家收單→外送員送達→多系統協作

軟體中的實現:
請求(Request) + 回應(Response) + 資料格式(JSON) = API溝通
```

**拆解成3個子問題:**
1. **認證授權**:「怎麼證明我有權限操作別人的系統?」
2. **資料轉換**:「我的資料格式跟對方的一樣嗎?」
3. **錯誤處理**:「如果對方系統掛了怎麼辦?」

---

## 📐 架構設計:整合流程圖

```
訂單系統 → Google Sheet 整合流程

觸發點:每週五晚上12點 (定時任務)
│
├─ 步驟1:從資料庫抓取本週訂單
│   └─ SELECT * FROM orders WHERE order_date >= '本週一'
│
├─ 步驟2:資料整理(轉換格式)
│   ├─ 原始資料:JSON格式
│   └─ 轉換成:表格行列格式
│
├─ 步驟3:連接Google Sheet API
│   ├─ 認證:使用服務帳號金鑰
│   └─ 取得試算表ID
│
├─ 步驟4:寫入資料
│   ├─ 清空舊資料(或新增分頁)
│   ├─ 寫入表頭:訂單編號、日期、客戶、金額、狀態
│   └─ 逐行寫入訂單資料
│
└─ 步驟5:通知完成
    └─ 寄信給會計:「本週報表已更新」
```

**學生練習:畫出自己的整合流程**

**產出文件**:`模組5_整合流程圖.md`

---

## 💬 Vibe Prompt範例

```markdown
# Google Sheet 整合需求

## 目標
每週自動將訂單資料匯出到Google Sheet,方便會計對帳。

## 資料來源
從Supabase的orders和order_items表抓取資料。

## 目標試算表
- Google Sheet名稱:「訂單週報表」
- Sheet ID:1234567890abcdef(請用這個ID)

## 試算表格式

**工作表1:本週訂單摘要**
欄位:
- A欄:訂單編號
- B欄:訂單日期
- C欄:客戶名稱
- D欄:商品清單(多項商品用逗號分隔)
- E欄:訂單金額
- F欄:訂單狀態

**工作表2:統計資訊**
- 總訂單數
- 總金額
- 各狀態訂單數量(待處理、已完成...)

## 執行時機
每週五晚上11:50執行(使用排程器)

## 認證方式
使用Google Service Account認證
金鑰檔案路徑:./config/google-credentials.json

## 流程
1. 查詢本週訂單(星期一00:00至星期日23:59)
2. 轉換成試算表格式
3. 清空「本週訂單摘要」工作表的舊資料
4. 寫入新資料
5. 更新「統計資訊」工作表
6. 發送email通知:「本週報表已更新,共X筆訂單」

## 錯誤處理
- 如果連不上Google API → 重試3次,失敗則寄信通知管理員
- 如果沒有訂單 → 依然建立試算表,顯示「本週無訂單」

請幫我生成這個整合程式的Python程式碼。
```

**學生練習:**
1. 先手動在Google Sheet建立試算表
2. 取得試算表ID
3. 設定服務帳號權限
4. 執行程式看結果

**產出文件**:`模組5_API整合文件.md`

---

## 🎯 可維護性重點:容錯機制

**教學生「外部系統不可靠,要做好備案」**

```
告訴AI加入容錯機制:

「請在程式中加入以下處理:

1. 連線逾時處理
   - 如果10秒內沒回應→重試
   - 重試3次都失敗→記錄錯誤,寄信通知

2. 資料驗證
   - 匯出前檢查資料是否完整
   - 如果金額欄位有空值→填0

3. 本地備份
   - 除了寫入Google Sheet,也存一份CSV在本地
   - 檔名:weekly_report_20250110.csv

4. 執行日誌
   - 每次執行記錄:時間、筆數、是否成功
   - 日誌存在:./logs/sheet_sync.log」
```
